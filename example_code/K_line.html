<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.staticfile.org/echarts/4.3.0/echarts.min.js"></script>
</head>
<body>
<div id="main" style="width: 1200px; height: 600px;"></div>
<script type="text/javascript">
    var stock_data =  [['2021-03-15', 37.77, 36.37, 36.19, 37.83, 0.346553, 'n', 0, 0, 0], ['2021-03-16', 36.8, 37.83, 36.3, 38.09, 0.463616, 'n', 0, 0, 0], ['2021-03-17', 37.69, 37.86, 37.46, 38.18, 0.257959, 'n', 0, 0, 0], ['2021-03-18', 37.88, 38.32, 37.86, 38.48, 0.293122, 'n', 0, 0, 0], ['2021-03-19', 38.1, 38.21, 37.52, 38.32, 0.378143, 'n', 0, 0, 0], ['2021-03-22', 38.44, 37.89, 37.23, 38.68, 0.395139, 'h', 0, 0, 0], ['2021-03-23', 37.87, 37.2, 36.83, 37.87, 0.299567, 'n', 0, 0, 0], ['2021-03-24', 37.2, 36.28, 36.16, 37.59, 0.473202, 'n', 0, 0, 0], ['2021-03-25', 36.5, 37.03, 36.43, 37.25, 0.367305, 'n', 0, 0, 0], ['2021-03-26', 37.26, 37.89, 37.09, 38.59, 0.378082, 'n', 0, 0, 0], ['2021-03-29', 38.27, 37.7, 37.14, 38.28, 0.276043, 'n', 0, 0, 0], ['2021-03-30', 37.78, 37.0, 36.49, 37.89, 0.448694, 'n', 0, 0, 0], ['2021-03-31', 36.78, 36.88, 36.3, 37.05, 0.191289, 'n', 0, 0, 0], ['2021-04-01', 36.51, 36.73, 36.51, 37.25, 0.300511, 'n', 0, 0, 0], ['2021-04-02', 37.0, 36.54, 36.23, 37.23, 0.316337, 'n', 0, 0, 0], ['2021-04-06', 36.56, 36.4, 36.2, 36.88, 0.223495, 'n', 0, 0, 0], ['2021-04-07', 36.4, 35.8, 35.7, 36.4, 0.308086, 'n', 0, 0, 0], ['2021-04-08', 35.65, 36.37, 35.06, 36.38, 0.350904, 'n', 0, 0, 0], ['2021-04-09', 36.22, 35.57, 35.35, 36.36, 0.231952, 'n', 0, 0, 0], ['2021-04-12', 35.54, 34.32, 34.22, 35.74, 0.320094, 'n', 0, 0, 0], ['2021-04-13', 34.19, 34.55, 34.11, 35.11, 0.200177, 'l', 0, 0, 0], ['2021-04-14', 34.55, 34.75, 34.37, 34.97, 0.21785, 'n', 0, 0, 0], ['2021-04-15', 34.8, 35.38, 34.63, 35.6, 0.236242, 'n', 0, 0, 0], ['2021-04-16', 35.48, 35.85, 35.0, 35.9, 0.273539, 'n', 0, 0, 0], ['2021-04-19', 35.75, 36.05, 35.38, 36.24, 0.350802, 'n', 0, 0, 0], ['2021-04-20', 36.2, 37.78, 36.05, 37.99, 0.591621, 'n', 0, 0, 0], ['2021-04-21', 37.76, 37.93, 37.28, 38.5, 0.51791, 'n', 0, 0, 0], ['2021-04-22', 38.08, 37.96, 37.59, 38.38, 0.370979, 'n', 0, 0, 0], ['2021-04-23', 38.05, 37.91, 37.73, 38.96, 0.386723, 'h', 0, 0, 0], ['2021-04-26', 37.8, 37.73, 37.6, 38.63, 0.434469, 'n', 0, 0, 0], ['2021-04-27', 37.74, 38.38, 37.53, 38.71, 0.478539, 'n', 0, 0, 0], ['2021-04-28', 38.51, 38.6, 38.15, 38.78, 0.363241, 'n', 0, 0, 0], ['2021-04-29', 38.6, 37.6, 37.28, 38.6, 0.488249, 'n', 0, 0, 0], ['2021-04-30', 37.59, 37.34, 37.0, 38.16, 0.305273, 'n', 0, 0, 0], ['2021-05-06', 37.32, 37.02, 36.37, 37.69, 0.38, 'n', 0, 0, 0], ['2021-05-07', 37.36, 36.39, 36.36, 37.4, 0.3, 'n', 0, 0, 0], ['2021-05-10', 36.28, 35.23, 34.98, 36.39, 0.45, 'l', 0, 0, 0], ['2021-05-11', 35.83, 37.24, 35.32, 37.37, 0.44, 'n', 0, 0, 0], ['2021-05-12', 37.35, 38.1, 37.01, 38.3, 0.45, 'h', 0, 0, 0], ['2021-05-13', 35.0, 36.75, 34.88, 37.48, 0.83, 'l', 0, 0, 0], ['2021-05-14', 36.72, 37.79, 36.51, 38.41, 0.6, 'h', 0, 0, 0], ['2021-05-17', 37.48, 37.01, 36.98, 38.32, 0.55, 'n', 0, 0, 0], ['2021-05-18', 37.18, 35.83, 35.4, 37.2, 0.52, 'n', 0, 0, 0], ['2021-05-19', 35.8, 35.83, 35.48, 36.85, 0.44, 'n', 0, 0, 0], ['2021-05-20', 35.6, 35.91, 35.59, 36.16, 0.22, 'n', 0, 0, 0], ['2021-05-21', 35.68, 35.04, 35.0, 36.29, 0.5, 'n', 0, 0, 0], ['2021-05-24', 35.05, 35.98, 34.34, 36.15, 0.6, 'n', 0, 0, 0], ['2021-05-25', 35.98, 36.3, 35.6, 36.42, 0.38, 'n', 0, 0, 0], ['2021-05-26', 36.6, 35.45, 35.39, 36.6, 0.3, 'n', 0, 0, 0], ['2021-05-28', 35.51, 35.08, 35.07, 35.96, 0.37, 'n', 0, 0, 0], ['2021-05-31', 35.1, 35.11, 35.03, 35.85, 0.3, 'n', 0, 0, 0], ['2021-06-01', 35.07, 35.16, 34.91, 35.49, 0.26, 'n', 0, 0, 0], ['2021-06-02', 35.16, 35.05, 34.9, 35.45, 0.24, 'n', 0, 0, 0], ['2021-06-03', 35.19, 34.7, 34.66, 35.31, 0.25, 'n', 0, 0, 0], ['2021-06-04', 34.61, 34.63, 34.12, 34.89, 0.27, 'n', 0, 0, 0], ['2021-06-07', 34.63, 34.74, 34.26, 35.08, 0.22, 'n', 0, 0, 0], ['2021-06-08', 34.98, 33.78, 33.56, 34.98, 0.34, 'n', 0, 0, 0], ['2021-06-09', 33.77, 34.02, 33.45, 34.39, 0.28, 'n', 0, 0, 0], ['2021-06-10', 34.01, 33.42, 32.99, 34.26, 0.48, 'n', 0, 0, 0], ['2021-06-11', 33.55, 33.4, 32.15, 33.55, 0.45, 'n', 0, 0, 0], ['2021-06-15', 33.28, 34.16, 33.14, 34.54, 0.41, 'n', 0, 0, 0], ['2021-06-16', 33.95, 32.92, 32.9, 34.14, 0.33, 'n', 0, 0, 0], ['2021-06-17', 32.81, 32.88, 32.3, 33.49, 0.27, 'n', 0, 0, 0], ['2021-06-18', 32.88, 32.95, 32.39, 33.2, 0.2, 'n', 0, 0, 0], ['2021-06-21', 33.07, 33.08, 32.68, 33.24, 0.19, 'n', 0, 0, 0], ['2021-06-22', 33.08, 32.31, 32.09, 33.2, 0.33, 'n', 0, 0, 0], ['2021-06-23', 32.45, 31.73, 31.3, 32.58, 0.36, 'n', 0, 0, 0], ['2021-06-24', 31.54, 31.83, 31.35, 32.32, 0.27, 'n', 0, 0, 0], ['2021-06-25', 31.83, 30.88, 30.81, 32.1, 0.63, 'n', 0, 0, 0], ['2021-06-28', 31.0, 31.73, 30.91, 31.99, 0.32, 'n', 0, 0, 0], ['2021-06-29', 31.73, 31.34, 30.86, 32.04, 0.32, 'n', 0, 0, 0], ['2021-06-30', 31.25, 31.16, 30.73, 31.25, 0.24, 'n', 0, 0, 0], ['2021-07-01', 31.11, 30.76, 30.76, 31.43, 0.25, 'n', 0, 0, 0], ['2021-07-02', 31.0, 30.84, 30.5, 31.0, 0.25, 'l', 0, 0, 0], ['2021-07-05', 30.85, 32.04, 30.85, 32.3, 0.48, 'n', 0, 0, 0], ['2021-07-06', 32.3, 31.61, 30.88, 33.17, 0.68, 'n', 0, 0, 0], ['2021-07-07', 31.76, 32.63, 31.06, 32.79, 0.43, 'n', 0, 0, 0], ['2021-07-08', 32.62, 32.0, 31.62, 32.71, 0.32, 'n', 0, 0, 0], ['2021-07-09', 31.66, 32.0, 31.0, 32.05, 0.48, 'n', 0, 0, 0], ['2021-07-12', 31.82, 32.76, 31.8, 33.2, 1.17, 'n', 0, 0, 0], ['2021-07-13', 33.0, 36.04, 33.0, 36.04, 1.47, 'n', 0, 0, 0], ['2021-07-14', 36.7, 37.7, 36.08, 38.1, 1.92, 'n', 0, 0, 0], ['2021-07-15', 37.5, 38.06, 36.3, 38.26, 1.22, 'h', 0, 0, 0], ['2021-07-16', 38.06, 36.6, 36.15, 38.15, 0.95, 'n', 0, 0, 0], ['2021-07-19', 36.59, 36.51, 35.78, 36.96, 0.49, 'n', 0, 0, 0], ['2021-07-20', 36.04, 37.87, 36.01, 38.0, 1.54, 'n', 0, 0, 0], ['2021-07-21', 37.77, 37.38, 36.72, 37.85, 0.76, 'n', 0, 0, 0], ['2021-07-22', 37.38, 36.42, 36.07, 37.38, 0.72, 'n', 0, 0, 0], ['2021-07-23', 36.57, 34.48, 34.14, 36.67, 0.83, 'n', 0, 0, 0], ['2021-07-26', 34.32, 32.6, 32.1, 34.45, 1.01, 'n', 0, 0, 0], ['2021-07-27', 32.49, 32.0, 31.88, 33.09, 0.75, 'n', 0, 0, 0], ['2021-07-28', 31.78, 31.97, 31.08, 32.38, 0.49, 'n', 0, 0, 0], ['2021-07-29', 32.05, 31.45, 31.43, 32.74, 0.46, 'n', 0, 0, 0], ['2021-07-30', 31.51, 30.99, 30.78, 31.65, 0.6, 'n', 0, 0, 0], ['2021-08-02', 31.19, 31.89, 29.83, 32.11, 0.71, 'l', 0, 0, 0], ['2021-08-03', 31.76, 33.56, 31.61, 33.56, 0.87, 'n', 0, 0, 0], ['2021-08-04', 33.5, 33.83, 32.43, 33.86, 0.58, 'n', 0, 0, 0], ['2021-08-05', 33.86, 33.13, 32.91, 34.5, 0.49, 'h', 0, 0, 0], ['2021-08-06', 33.4, 31.96, 31.61, 33.4, 0.47, 'n', 0, 0, 0], ['2021-08-09', 32.3, 32.25, 31.67, 32.5, 0.38, 'n', 0, 0, 0], ['2021-08-10', 32.5, 32.36, 31.85, 32.64, 0.28, 'n', 0, 0, 0], ['2021-08-11', 32.49, 31.92, 31.85, 33.1, 0.42, 'n', 0, 0, 0], ['2021-08-12', 31.87, 31.75, 31.51, 32.2, 0.29, 'n', 0, 0, 0], ['2021-08-13', 31.78, 32.25, 31.45, 32.27, 0.44, 'l', 0, 0, 0], ['2021-08-16', 32.5, 34.45, 32.5, 35.24, 1.31, 'h', 0, 0, 0], ['2021-08-17', 34.25, 33.13, 31.91, 34.38, 0.73, 'n', 0, 0, 0], ['2021-08-18', 32.5, 32.47, 31.33, 32.85, 0.82, 'n', 0, 0, 0], ['2021-08-19', 32.92, 32.48, 31.93, 32.92, 0.3, 'n', 0, 0, 0], ['2021-08-20', 32.11, 31.51, 31.51, 32.76, 0.47, 'n', 0, 0, 0], ['2021-08-23', 31.52, 30.98, 30.9, 32.0, 0.78, 'n', 0, 0, 0], ['2021-08-24', 31.15, 30.36, 29.8, 31.41, 0.86, 'n', 0, 0, 0], ['2021-08-25', 30.48, 31.33, 29.62, 31.47, 0.69, 'n', 0, 0, 0], ['2021-08-26', 31.33, 30.18, 30.06, 31.75, 0.49, 'n', 0, 0, 0], ['2021-08-27', 29.85, 30.24, 29.85, 30.56, 0.32, 'n', 0, 0, 0], ['2021-08-30', 30.05, 30.5, 29.65, 30.75, 0.5, 'n', 0, 0, 0], ['2021-08-31', 30.31, 30.02, 29.83, 30.75, 0.37, 'n', 0, 0, 0], ['2021-09-01', 30.0, 29.5, 28.28, 30.16, 0.77, 'l', 0, 0, 0], ['2021-09-02', 29.45, 28.59, 28.57, 29.8, 0.88, 'n', 0, 0, 0], ['2021-09-03', 28.66, 28.36, 28.34, 29.18, 0.54, 'n', 0, 0, 0], ['2021-09-06', 28.88, 30.47, 28.51, 30.88, 1.06, 'h', 0, 0, 0], ['2021-09-07', 30.54, 29.93, 29.7, 30.6, 0.44, 'n', 0, 0, 0], ['2021-09-08', 29.71, 29.6, 29.38, 29.89, 0.33, 'n', 0, 0, 0], ['2021-09-09', 29.9, 28.5, 28.42, 29.9, 0.74, 'l', 0, 0, 0]]
    function splitData(rawData) {
      var datas = [];
      var times = [];
      var vols = [];
      var difs = [];
      var deas = [];
      for (var i = 0; i < rawData.length; i++) {
          datas.push(rawData[i]);
          times.push(rawData[i].splice(0, 1)[0]);
          vols.push(rawData[i][4]);
          difs.push(rawData[i][7]);
          deas.push(rawData[i][8]);
      }
      return {
          datas: datas,
          times: times,
          vols: vols,
          difs: difs,
          deas: deas
      };
    }

    //分段计算
    function fenduans(data){
      var markLineData = [];
      var idx = 0; var tag = 0; var vols = 0;
      for (var i = 0; i < data.times.length; i++) {
          console.log(`分段计算:${data.datas[i]}`)
          if(data.datas[i][5] != "n" ){
              if (tag == 0){
                idx = i;
                tag = 1;
                continue;
              }
              markLineData.push([{
                  xAxis: idx,
                  yAxis: data.datas[idx][5] == "h"?(data.datas[idx][3]).toFixed(2):(data.datas[idx][2]).toFixed(2),
                  value: vols
              }, {
                  xAxis: i,
                  yAxis: data.datas[i][5] == "h"?(data.datas[i][3]).toFixed(2):(data.datas[i][2]).toFixed(2),
              }]);
              idx = i; vols = 0;
          }
       }
      console.log(`线段列表:${markLineData}`)
      return markLineData;
    }

    //MA计算公式
    function calculateMA(dayCount,data) {
      var result = [];
      for (var i = 0, len = data.times.length; i < len; i++) {
          if (i < dayCount) {
              result.push('-');
              continue;
          }
          var sum = 0;
          for (var j = 0; j < dayCount; j++) {
              sum += data.datas[i - j][1];
          }
          result.push((sum / dayCount).toFixed(2));
      }
      return result;
    }
    var data = splitData(stock_data);
    var option = {
              title: {
                  text: `test`,
                  left: 0
              },
              tooltip: {
                  trigger: 'axis',
                  axisPointer: {
                      type: 'line'
                  }
              },
              legend: {
                  data: ['KLine', 'MA5']
              },
              grid: [           {
                  left: '3%',
                  right: '1%',
                  height: '65%'
              },{
                  left: '3%',
                  right: '1%',
                  top: '80%',
                  height: '16%'
              }],
              xAxis: [{
                  type: 'category',
                  data: data.times,
                  scale: true,
                  boundaryGap: false,
                  axisLine: { onZero: false },
                  splitLine: { show: false },
                  splitNumber: 20,
                  min: 'dataMin',
                  max: 'dataMax'
              },{
                  type: 'category',
                  gridIndex: 1,
                  data: data.times,
                  axisLabel: {show: false}
              }],
              yAxis: [{
                  scale: true,
                  splitArea: {
                      show: false
                  }
              },{
                  gridIndex: 1,
                  splitNumber: 3,
                  axisLine: {onZero: false},
                  axisTick: {show: false},
                  splitLine: {show: false},
                  axisLabel: {show: true}
              }],
              dataZoom: [{
                      type: 'inside',
                      xAxisIndex: [0, 0],
                      start: 20,
                      end: 100
                },{
                      show: true,
                      xAxisIndex: [0, 1],
                      type: 'slider',
                      top: '97%',
                      start: 20,
                      end: 100
                }
                ],
              series: [{
                      name: 'K线周期图表',
                      type: 'candlestick',
                      data: data.datas,
                      itemStyle: {
                          normal: {
                              color: '#ef232a',
                              color0: '#14b143',
                              borderColor: '#ef232a',
                              borderColor0: '#14b143',
                          }
                      },

                      markPoint: {
                          data: [
                              {type: 'max', name: '最大值'},
                              {type: 'min', name: '最小值'}
                          ]
                      },
                      markLine: {
                          label: {
                              normal: {
                                  position: 'middle',
                                  textStyle:{color:'Blue',fontSize: 8}
                              }
                          },
                          lineStyle:{
                            color:'black',//'gold',
                          },
                          data: fenduans(data),
                          symbol: ['none', 'none']

                      }
                  }, {
                      name: 'MA5',
                      type: 'line',
                      data: calculateMA(5,data),
                      smooth: true,
                      lineStyle: {
                          normal: {
                              opacity: 0.5
                          }
                      }
                  },{
                      name: 'Volumn',
                      type: 'bar',
                      xAxisIndex: 1,
                      yAxisIndex: 1,
                      data: data.vols,
                      itemStyle: {
                          normal: {
                              color: function(params) {
                                  var colorList;
                                  console.log('debug:',params,'data:',data.datas[params.dataIndex],data.datas[params.dataIndex][1],data.datas[params.dataIndex][0])
                                  if (data.datas[params.dataIndex][1]>data.datas[params.dataIndex][0]) {
                                      colorList = '#ef232a';
                                  } else {
                                      colorList = '#14b143';
                                  }
                                  return colorList;
                              },
                          }
                      }
                  }
              ]
            };
    var myChart = echarts.init(document.getElementById('main'));
    myChart.setOption(option);

</script>
</body>
</html>